name: Check Hugo Version

on:
  schedule:
    # Run on the 1st of every month at 9am UTC (1am PT / 2am PT depending on DST)
    - cron: '0 9 1 * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-hugo-version:
    runs-on: ubuntu-latest
    
    permissions:
      issues: write # Required to create issues
      contents: read # Required to read repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Check Hugo version
        id: hugo-check
        run: |
          # Run the script and capture only the JSON output (last line should be JSON)
          npm run check:hugo -- --json 2>&1 | tail -1 > hugo-status.json || echo '{"error": "Script failed"}' > hugo-status.json
          # Validate it's JSON
          if ! jq empty hugo-status.json 2>/dev/null; then
            echo "Warning: Output is not valid JSON"
            cat hugo-status.json
            echo '{"error": "Invalid JSON output"}' > hugo-status.json
          fi
          cat hugo-status.json
        continue-on-error: true
      
      - name: Parse Hugo status
        id: parse-status
        run: |
          if [ -f hugo-status.json ] && [ -s hugo-status.json ]; then
            # Check if JSON is valid
            if jq empty hugo-status.json 2>/dev/null; then
              SECURITY_ISSUES=$(cat hugo-status.json | jq -r '.hasSecurityIssues // false')
              UPDATE_AVAILABLE=$(cat hugo-status.json | jq -r '.updateAvailable // false')
              CURRENT_VERSION=$(cat hugo-status.json | jq -r '.currentVersion // "unknown"')
              LATEST_VERSION=$(cat hugo-status.json | jq -r '.latestVersion // "unknown"')
              VERSION_BEHIND=$(cat hugo-status.json | jq -r '.versionBehind // null')
            else
              echo "Invalid JSON in hugo-status.json"
              SECURITY_ISSUES="false"
              UPDATE_AVAILABLE="false"
              CURRENT_VERSION="unknown"
              LATEST_VERSION="unknown"
              VERSION_BEHIND="null"
            fi
          else
            echo "hugo-status.json not found or empty"
            SECURITY_ISSUES="false"
            UPDATE_AVAILABLE="false"
            CURRENT_VERSION="unknown"
            LATEST_VERSION="unknown"
            VERSION_BEHIND="null"
          fi
          
          echo "security_issues=$SECURITY_ISSUES" >> $GITHUB_OUTPUT
          echo "update_available=$UPDATE_AVAILABLE" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "version_behind=$VERSION_BEHIND" >> $GITHUB_OUTPUT
      
      - name: Generate report
        id: report
        run: |
          REPORT="## üîç Hugo Version Check Report\n\n"
          REPORT+="**Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')\n\n"
          
          # Parse version behind info
          VERSION_BEHIND_TYPE=$(echo '${{ steps.parse-status.outputs.version_behind }}' | jq -r '.type // "none"' 2>/dev/null || echo "none")
          VERSION_BEHIND_COUNT=$(echo '${{ steps.parse-status.outputs.version_behind }}' | jq -r '.count // 0' 2>/dev/null || echo "0")
          
          # Summary section at the top
          REPORT+="### üìä Quick Summary\n\n"
          REPORT+="| Item | Status |\n"
          REPORT+="|------|--------|\n"
          REPORT+="| **Current Hugo Version** | \`${{ steps.parse-status.outputs.current_version }}\` |\n"
          REPORT+="| **Latest Hugo Version** | \`${{ steps.parse-status.outputs.latest_version }}\` |\n"
          
          if [ "${{ steps.parse-status.outputs.security_issues }}" == "true" ]; then
            REPORT+="| **Security Status** | üö® **VULNERABLE** - Action Required |\n"
            REPORT+="| **Update Status** | ‚ö†Ô∏è  **OUTDATED** |\n\n"
            REPORT+="### üö® ACTION REQUIRED: Security Issues Detected\n\n"
            REPORT+="**Your Hugo version has known security vulnerabilities and must be updated immediately.**\n\n"
            REPORT+="**What to do:**\n"
            REPORT+="1. Update Hugo: \`npm install hugo-bin@latest\`\n"
            REPORT+="2. Test your site: \`npm run build && npm test\`\n"
            REPORT+="3. Commit and push the changes\n\n"
          elif [ "${{ steps.parse-status.outputs.update_available }}" == "true" ]; then
            if [ "$VERSION_BEHIND_TYPE" != "none" ] && [ "$VERSION_BEHIND_COUNT" != "0" ]; then
              REPORT+="| **Security Status** | ‚úÖ **SECURE** |\n"
              if [ "$VERSION_BEHIND_TYPE" == "major" ]; then
                REPORT+="| **Update Status** | ‚ö†Ô∏è  **$VERSION_BEHIND_COUNT major version(s) behind** |\n\n"
              elif [ "$VERSION_BEHIND_TYPE" == "minor" ]; then
                REPORT+="| **Update Status** | üí° **$VERSION_BEHIND_COUNT minor version(s) behind** |\n\n"
              else
                REPORT+="| **Update Status** | üí° **$VERSION_BEHIND_COUNT patch version(s) behind** |\n\n"
              fi
            else
              REPORT+="| **Security Status** | ‚úÖ **SECURE** |\n"
              REPORT+="| **Update Status** | üí° **Update Available** |\n\n"
            fi
            REPORT+="### üí° Update Available\n\n"
            REPORT+="A newer version of Hugo is available. You're currently on \`${{ steps.parse-status.outputs.current_version }}\` and the latest is \`${{ steps.parse-status.outputs.latest_version }}\`.\n\n"
            REPORT+="**Recommended action:**\n"
            REPORT+="1. Update Hugo: \`npm install hugo-bin@latest\`\n"
            REPORT+="2. Test your site: \`npm run build && npm test\`\n"
            REPORT+="3. Commit and push the changes\n\n"
            REPORT+="*Note: This is not urgent, but keeping dependencies up to date is recommended.*\n\n"
          else
            REPORT+="| **Security Status** | ‚úÖ **SECURE** |\n"
            REPORT+="| **Update Status** | ‚úÖ **UP TO DATE** |\n\n"
            REPORT+="### ‚úÖ All Good!\n\n"
            REPORT+="Your Hugo version (\`${{ steps.parse-status.outputs.current_version }}\`) is current. No action needed.\n\n"
          fi
          
          REPORT+="---\n\n"
          REPORT+="### üìã Detailed Information\n\n"
          REPORT+="<details>\n<summary>Click to view full JSON report</summary>\n\n"
          REPORT+="\`\`\`json\n"
          REPORT+="$(cat hugo-status.json 2>/dev/null || echo 'Unable to generate full report')\n"
          REPORT+="\`\`\`\n\n"
          REPORT+="</details>\n\n"
          REPORT+="---\n\n"
          REPORT+="**üí° Tip:** Run \`npm run check:hugo\` locally anytime to check your Hugo version.\n\n"
          REPORT+="*This is an automated monthly check. Issues are created when updates are available or security issues are detected.*\n"
          
          echo "$REPORT" > report.md
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Create or update issue
        if: steps.parse-status.outputs.security_issues == 'true' || steps.parse-status.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const report = `${{ steps.report.outputs.report }}`;
            const title = `${{ steps.parse-status.outputs.security_issues == 'true' && 'üö® Hugo Security Update Required' || 'üí° Hugo Update Available' }} - ${{ steps.parse-status.outputs.current_version }} ‚Üí ${{ steps.parse-status.outputs.latest_version }}`;
            
            // Check if an open issue with this title already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'hugo-version-check'
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes('Hugo') && 
              (issue.title.includes('Security') || issue.title.includes('Update Available'))
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: report
              });
              
              // Update title if version changed
              if (!existingIssue.title.includes('${{ steps.parse-status.outputs.latest_version }}')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  title: title
                });
              }
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: report,
                labels: ['hugo-version-check', '${{ steps.parse-status.outputs.security_issues == 'true' && 'security' || 'maintenance' }}']
              });
            }
      
      - name: Summary
        run: |
          echo "## Hugo Version Check Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Version:** ${{ steps.parse-status.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Latest Version:** ${{ steps.parse-status.outputs.latest_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.parse-status.outputs.security_issues }}" == "true" ]; then
            echo "üö® **Security issues detected!** An issue has been created." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.parse-status.outputs.update_available }}" == "true" ]; then
            echo "üí° **Update available.** An issue has been created." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Status: Up to date**" >> $GITHUB_STEP_SUMMARY
          fi
