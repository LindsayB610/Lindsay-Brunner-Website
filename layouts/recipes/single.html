{{ define "main" }}
<article class="section" data-url="{{ .Permalink | absURL }}">
  <div class="container-narrow">
    <header style="text-align: center; margin-bottom: 3rem; position: relative;">
      <button 
        onclick="if (window.plausible) { window.plausible('Print Recipe', { props: { recipe: '{{ .Title | js }}', url: '{{ .Permalink | absURL | js }}' } }); } window.print();" 
        class="print-button print-icon-button"
        style="position: absolute; top: 0; right: 0; z-index: 10;"
        aria-label="Print recipe"
      >
        <svg viewBox="0 0 24 24">
          <path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-4h8v2zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/>
          <circle cx="18" cy="11.5" r="1"/>
        </svg>
      </button>
      <div
        class="post-meta"
        style="justify-content: center; margin-bottom: 1.5rem"
      >
        <time>{{ .Date.Format "January 2, 2006" }}</time>
        {{ if .Site.Params.show_reading_time }}
        <span>•</span>
        <span>{{ .ReadingTime }} min read</span>
        {{ end }}
      </div>
      
      <div style="margin-bottom: 1.5rem; text-align: center;">
        <a href="/recipes/all/" style="color: var(--color-pink); text-decoration: none; font-weight: 500; font-size: 0.9rem;">
          Browse all recipes →
        </a>
      </div>

      <h1 class="recipe-single-title-with-icons">
        {{ .Title }}
        {{ partial "recipe-dietary-icons.html" (dict "page" . "base" "/recipes/") }}
      </h1>

      {{ if .Params.subtitle }}
      <p
        style="
          font-size: 1.25rem;
          color: var(--dark-text-secondary);
          margin-top: 1.5rem;
          font-style: italic;
        "
      >
        {{ .Params.subtitle }}
      </p>
      {{ end }}

      {{ if or .Params.totalTime .Params.prepTime .Params.cookTime }}
      <p
        style="
          font-size: 0.9rem;
          color: var(--dark-text-secondary);
          margin-top: 1rem;
          font-weight: 400;
        "
      >
        {{ if .Params.totalTime }}
          <strong>Total time:</strong> {{ partial "format-duration.html" .Params.totalTime }}
        {{ end }}
        {{ if and .Params.prepTime .Params.cookTime }}
          {{ if .Params.totalTime }} • {{ end }}
          <strong>Active:</strong> {{ partial "format-duration.html" .Params.prepTime }} • 
          <strong>Inactive:</strong> {{ partial "format-duration.html" .Params.cookTime }}
        {{ else if .Params.prepTime }}
          {{ if .Params.totalTime }} • {{ end }}
          <strong>Active:</strong> {{ partial "format-duration.html" .Params.prepTime }}
        {{ else if .Params.cookTime }}
          {{ if .Params.totalTime }} • {{ end }}
          <strong>Inactive:</strong> {{ partial "format-duration.html" .Params.cookTime }}
        {{ end }}
      </p>
      {{ end }}
    </header>

    <div class="article-content" data-url="{{ .Permalink | absURL }}">{{ .Content }}</div>
    
    <!-- Recipe action buttons (print and email) -->
    <div class="recipe-actions">
      <button 
        onclick="if (window.plausible) { window.plausible('Print Recipe', { props: { recipe: '{{ .Title | js }}', url: '{{ .Permalink | absURL | js }}' } }); } window.print();" 
        class="recipe-action-button print-button"
        aria-label="Print recipe"
      >
        <svg viewBox="0 0 24 24">
          <path d="M19 8h-1V3H6v5H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zM8 5h8v3H8V5zm8 12v2H8v-4h8v2zm2-2v-2H6v2H4v-4c0-.55.45-1 1-1h14c.55 0 1 .45 1 1v4h-2z"/>
          <circle cx="18" cy="11.5" r="1"/>
        </svg>
        Print
      </button>
      <a 
        href="mailto:?subject={{ .Title | urlquery }}&body={{ printf "Check out this recipe: %s" (.Permalink | absURL) | urlquery }}"
        class="recipe-action-button"
        aria-label="Email recipe"
        onclick="if (window.plausible) { window.plausible('Email Recipe', { props: { recipe: '{{ .Title | js }}', url: '{{ .Permalink | absURL | js }}' } }); }"
      >
        <svg viewBox="0 0 24 24">
          <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
        </svg>
        Email
      </a>
    </div>
    
    <!-- Print-only URL footer -->
    <div class="print-url" style="display: none;">
      Recipe from: {{ .Permalink | absURL }}
    </div>
  </div>
</article>

{{ if .Params.related_recipes }}
  {{ $relatedRecipes := .Params.related_recipes }}
  {{ if $relatedRecipes }}
  <section class="section no-print">
    <div class="container-narrow">
      <h2 style="margin-bottom: 2rem; text-align: left">Make something else</h2>
      <ul style="list-style: disc; padding-left: 1.5rem; display: flex; flex-direction: column; gap: 1rem">
        {{ range $relatedRecipes }}
        <li>
          <a href="{{ .url }}" style="color: var(--brand-primary); text-decoration: none; font-weight: 500;">
            {{ .title }}
          </a>
          {{ if .subtitle }}
          <p style="color: var(--dark-text-secondary); margin-top: 0.25rem; font-size: 0.9rem;">
            {{ .subtitle }}
          </p>
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </div>
  </section>
  {{ end }}
{{ else }}
  {{ $allRecipes := where (where .Site.RegularPages "Type" "recipes") "Draft" false }}
  {{ $otherRecipes := where $allRecipes "Permalink" "!=" .Permalink }}
  {{ $recentRecipes := $otherRecipes.ByDate.Reverse | first 3 }}
  {{ if $recentRecipes }}
  <section class="section no-print">
    <div class="container-narrow">
      <h2 style="margin-bottom: 2rem; text-align: left">Make something else</h2>
      <ul style="list-style: disc; padding-left: 1.5rem; display: flex; flex-direction: column; gap: 1rem">
        {{ range $recentRecipes }}
        <li>
          <a href="{{ .RelPermalink }}" style="color: var(--brand-primary); text-decoration: none; font-weight: 500;">
            {{ .Title }}
          </a>
          {{ if .Params.subtitle }}
          <p style="color: var(--dark-text-secondary); margin-top: 0.25rem; font-size: 0.9rem;">
            {{ .Params.subtitle }}
          </p>
          {{ end }}
        </li>
        {{ end }}
      </ul>
    </div>
  </section>
  {{ end }}
{{ end }}

<!-- Recipe JSON-LD Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Recipe",
  "name": {{ .Title | jsonify }},
  "url": {{ .Permalink | jsonify }},
  {{- if .Params.recipe_image }}
  "image": {{ (.Params.recipe_image | absURL) | jsonify }},
  {{- else if .Params.social_image }}
  "image": {{ (.Params.social_image | absURL) | jsonify }},
  {{- else if .Site.Params.default_social_image }}
  "image": {{ (.Site.Params.default_social_image | absURL) | jsonify }},
  {{- end }}
  "author": {
    "@type": "Person",
    "name": {{ .Site.Params.author | jsonify }}
  },
  "datePublished": {{ (.Date.UTC.Format "2006-01-02T15:04:05Z") | jsonify }},
  "description": {{ .Params.description | jsonify }}{{ if .Params.prepTime }},
  "prepTime": {{ .Params.prepTime | jsonify }}{{ end }}{{ if .Params.cookTime }},
  "cookTime": {{ .Params.cookTime | jsonify }}{{ end }}{{ if .Params.totalTime }},
  "totalTime": {{ .Params.totalTime | jsonify }}{{ end }}{{ if .Params.recipeYield }},
  "recipeYield": {{ .Params.recipeYield | jsonify }}{{ end }}{{ if .Params.recipeCategory }},
  "recipeCategory": {{ .Params.recipeCategory | jsonify }}{{ end }}{{ if .Params.recipeCuisine }},
  "recipeCuisine": {{ .Params.recipeCuisine | jsonify }}{{ end }}{{ if .Params.recipeIngredient }},
  "recipeIngredient": [
    {{- range $index, $ingredient := .Params.recipeIngredient }}
      {{- if $index }},{{ end }}
      {{ $ingredient | jsonify }}
    {{- end }}
  ]{{ end }}{{ if .Params.recipeInstructions }}{{ if or .Params.recipeIngredient .Params.prepTime .Params.cookTime .Params.totalTime .Params.recipeYield .Params.recipeCategory .Params.recipeCuisine }},{{ end }}
  "recipeInstructions": [
    {{- range $index, $instruction := .Params.recipeInstructions }}
      {{- if $index }},{{ end }}
      {
        "@type": "HowToStep",
        "text": {{ $instruction | jsonify }},
        "url": {{ $.Permalink | jsonify }}
      }
    {{- end }}
  ]{{ end }}
}
</script>

<!-- Breadcrumbs JSON-LD Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": {{ .Site.BaseURL | jsonify }}
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Recipes",
      "item": {{ (printf "%s/recipes/" .Site.BaseURL) | jsonify }}
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": {{ .Title | jsonify }},
      "item": {{ .Permalink | jsonify }}
    }
  ]
}
</script>
{{ end }}
