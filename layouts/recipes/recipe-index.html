{{ define "main" }}
<section class="section">
  <div class="container">
    <div class="section-title">
      <h1>{{ .Title }}</h1>
    </div>

    {{ partial "recipe-diet-filters.html" (dict "base" "/recipes/all/") }}

    {{/* Get all published recipes from the recipes section */}}
    {{ $allRecipes := where .Site.RegularPages "Section" "recipes" }}
    {{ $allRecipes = where $allRecipes "Draft" false }}
    {{/* Exclude the recipe-index page from the list */}}
    {{ $allRecipes = where $allRecipes "RelPermalink" "!=" "/recipes/all/" }}
    {{ $allRecipes = $allRecipes.ByDate.Reverse }}

    {{ if $allRecipes }}
      {{/* Group recipes by category */}}
      {{ $categories := slice }}
      {{ range $allRecipes }}
        {{ if .Params.recipeCategory }}
          {{ $categories = $categories | append .Params.recipeCategory }}
        {{ end }}
      {{ end }}
      {{ $uniqueCategories := $categories | uniq | sort }}

      {{/* Split categories: Appetizer through Dessert in left column, rest in right */}}
      {{ $leftCategories := slice }}
      {{ $rightCategories := slice }}
      {{ $foundDessert := false }}
      {{ range $uniqueCategories }}
        {{ if or (eq . "Dessert") (not $foundDessert) }}
          {{ $leftCategories = $leftCategories | append . }}
          {{ if eq . "Dessert" }}
            {{ $foundDessert = true }}
          {{ end }}
        {{ else }}
          {{ $rightCategories = $rightCategories | append . }}
        {{ end }}
      {{ end }}

      {{/* Display recipes grouped by category in two columns */}}
      <div class="recipe-index-categories-grid">
        <div class="recipe-index-column">
          {{ range $leftCategories }}
            {{ $category := . }}
            {{ $categoryRecipes := where $allRecipes "Params.recipeCategory" $category }}
            {{ $categoryRecipes = $categoryRecipes.ByTitle }}
            
            <div class="recipe-index-category">
              <h2 class="recipe-index-category-title">
                {{ $category }}<span class="recipe-index-category-count">{{ len $categoryRecipes }}</span>
              </h2>
              
              <ul class="recipe-index-list">
                {{ range $categoryRecipes }}
                <li class="recipe-index-item" {{ with .Params.dietary }}data-diet="{{ delimit (apply . "urlize" ".") " " }}"{{ end }}>
                  <div class="recipe-index-link">
                    <span class="recipe-index-title-wrap">
                      <a href="{{ .RelPermalink }}" class="recipe-index-title">{{ .Title }}</a>
                      {{ partial "recipe-dietary-icons.html" (dict "page" . "base" "/recipes/all/") }}
                    </span>
                    {{ if or .Params.totalTime .Params.recipeYield }}
                    <a href="{{ .RelPermalink }}" class="recipe-index-meta-link">
                      <span class="recipe-index-meta">
                        {{ if .Params.totalTime }}
                          <span>{{ partial "format-duration.html" .Params.totalTime }}</span>
                        {{ end }}
                        {{ if and .Params.totalTime .Params.recipeYield }} • {{ end }}
                        {{ if .Params.recipeYield }}
                          <span>{{ .Params.recipeYield }}</span>
                        {{ end }}
                      </span>
                    </a>
                    {{ end }}
                  </div>
                </li>
                {{ end }}
              </ul>
            </div>
          {{ end }}
        </div>

        <div class="recipe-index-column">
          {{ range $rightCategories }}
            {{ $category := . }}
            {{ $categoryRecipes := where $allRecipes "Params.recipeCategory" $category }}
            {{ $categoryRecipes = $categoryRecipes.ByTitle }}
            
            <div class="recipe-index-category">
              <h2 class="recipe-index-category-title">
                {{ $category }}<span class="recipe-index-category-count">{{ len $categoryRecipes }}</span>
              </h2>
              
              <ul class="recipe-index-list">
                {{ range $categoryRecipes }}
                <li class="recipe-index-item" {{ with .Params.dietary }}data-diet="{{ delimit (apply . "urlize" ".") " " }}"{{ end }}>
                  <div class="recipe-index-link">
                    <span class="recipe-index-title-wrap">
                      <a href="{{ .RelPermalink }}" class="recipe-index-title">{{ .Title }}</a>
                      {{ partial "recipe-dietary-icons.html" (dict "page" . "base" "/recipes/all/") }}
                    </span>
                    {{ if or .Params.totalTime .Params.recipeYield }}
                    <a href="{{ .RelPermalink }}" class="recipe-index-meta-link">
                      <span class="recipe-index-meta">
                        {{ if .Params.totalTime }}
                          <span>{{ partial "format-duration.html" .Params.totalTime }}</span>
                        {{ end }}
                        {{ if and .Params.totalTime .Params.recipeYield }} • {{ end }}
                        {{ if .Params.recipeYield }}
                          <span>{{ .Params.recipeYield }}</span>
                        {{ end }}
                      </span>
                    </a>
                    {{ end }}
                  </div>
                </li>
                {{ end }}
              </ul>
            </div>
          {{ end }}
        </div>
      </div>

      {{/* Show recipes without a category at the end (full width) */}}
      {{ $uncategorizedRecipes := where $allRecipes "Params.recipeCategory" "eq" nil }}
      {{ if $uncategorizedRecipes }}
        {{ $uncategorizedRecipes = $uncategorizedRecipes.ByTitle }}
        <div class="recipe-index-category recipe-index-category-full-width">
          <h2 class="recipe-index-category-title">
            Other<span class="recipe-index-category-count">{{ len $uncategorizedRecipes }}</span>
          </h2>
          
          <ul class="recipe-index-list">
            {{ range $uncategorizedRecipes }}
            <li class="recipe-index-item" {{ with .Params.dietary }}data-diet="{{ delimit (apply . "urlize" ".") " " }}"{{ end }}>
              <div class="recipe-index-link">
                <span class="recipe-index-title-wrap">
                  <a href="{{ .RelPermalink }}" class="recipe-index-title">{{ .Title }}</a>
                  {{ partial "recipe-dietary-icons.html" (dict "page" . "base" "/recipes/all/") }}
                </span>
                {{ if or .Params.totalTime .Params.recipeYield }}
                <a href="{{ .RelPermalink }}" class="recipe-index-meta-link">
                  <span class="recipe-index-meta">
                    {{ if .Params.totalTime }}
                      <span>{{ partial "format-duration.html" .Params.totalTime }}</span>
                    {{ end }}
                    {{ if and .Params.totalTime .Params.recipeYield }} • {{ end }}
                    {{ if .Params.recipeYield }}
                      <span>{{ .Params.recipeYield }}</span>
                    {{ end }}
                  </span>
                </a>
                {{ end }}
              </div>
            </li>
            {{ end }}
          </ul>
        </div>
      {{ end }}

    {{ else }}
      <div class="no-posts">
        <h2>Coming Soon</h2>
        <p>
          Recipes are cooking! Check back soon for tested recipes and kitchen experiments.
        </p>
      </div>
    {{ end }}
  </div>
</section>
<script>
(function() {
  var params = new URLSearchParams(window.location.search);
  var diet = params.get('diet') && params.get('diet').trim() ? params.get('diet').trim() : null;
  var chips = document.querySelectorAll('.recipe-diet-filter-chip');
  chips.forEach(function(chip) {
    chip.classList.toggle('is-active', (chip.getAttribute('data-diet-filter') || '') === (diet || ''));
  });
  var items = document.querySelectorAll('.recipe-index-item');
  items.forEach(function(item) {
    var dataDiet = item.getAttribute('data-diet') || '';
    var diets = dataDiet ? dataDiet.split(/\s+/) : [];
    if (diet) {
      item.style.display = diets.indexOf(diet) !== -1 ? '' : 'none';
    } else {
      item.style.display = '';
    }
  });
})();
</script>
{{ end }}
